name: Build Deps (Windows)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Verify MSVC
        shell: powershell
        run: |
          cl.exe

      - name: Build gRPC
        shell: cmd
        run: |
          git clone -b v1.66.1 --recurse-submodules https://github.com/grpc/grpc
          cmake -S grpc -B grpc\build -GNinja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INSTALL_PREFIX=C:\opt\grpc ^
            -DABSL_PROPAGATE_CXX_STD=ON ^
            -DABSL_ENABLE_INSTALL=ON
          cmake --build grpc\build
          cmake --install grpc\build

      - name: Build AWS SDK (S3 only)
        shell: cmd
        run: |
          git clone --recurse-submodules https://github.com/aws/aws-sdk-cpp.git
          cmake -S aws-sdk-cpp -B aws-sdk-cpp\build -GNinja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INSTALL_PREFIX=C:\opt\aws ^
            -DBUILD_ONLY=s3 ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DENABLE_TESTING=OFF
          cmake --build aws-sdk-cpp\build
          cmake --install aws-sdk-cpp\build

      - name: Package artifacts
        shell: powershell
        run: |
          Compress-Archive -Path C:\opt\grpc\* grpc-v1.66.1-windows-x64.zip
          Compress-Archive -Path C:\opt\aws\* aws-sdk-s3-v1.11-windows-x64.zip

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: deps-v1
          files: |
            grpc-v1.66.1-windows-x64.zip
            aws-sdk-s3-v1.11-windows-x64.zip